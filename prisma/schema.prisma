generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Merchant {
  id              String    @id @default(cuid())
  slug            String    @unique
  salesforceId    String?   @unique
  companyName     String
  email           String    @unique
  passwordHash    String
  address         String?
  phone           String?
  onboardingStage String    @default("new")
  installationDate DateTime?
  trainingDate    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model LarkAuthToken {
  id           String   @id @default(cuid())
  userEmail    String   @unique
  userName     String?
  larkUserId   String?
  userType     String?  // 'trainer', 'installer', or 'manager'
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime
  calendarId   String?
  scopes       String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userEmail])
  @@index([expiresAt])
  @@index([userType])
}

model PageView {
  id            String   @id @default(cuid())
  merchantId    String?  // Salesforce ID (nullable for login page visits)
  merchantName  String?  // Cached for easier querying
  page          String   // 'progress', 'details', 'login', 'admin', etc.
  action        String?  // 'view', 'login_success', 'login_failed', 'booking', 'upload'
  userAgent     String?  @db.Text
  deviceType    String?  // 'mobile', 'tablet', 'desktop'
  ipAddress     String?  // Hashed IP for privacy
  sessionId     String   // To track unique sessions
  isInternalUser Boolean @default(false) // Flag for internal team access
  userType      String?  // 'merchant', 'internal_team', 'admin'
  metadata      Json?    // Additional context (e.g., booking details, error messages)
  timestamp     DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([merchantId])
  @@index([page])
  @@index([timestamp])
  @@index([sessionId])
  @@index([isInternalUser])
  @@index([userType])
  @@index([deviceType])
}