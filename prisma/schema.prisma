generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Merchant {
  id              String    @id @default(cuid())
  slug            String    @unique
  salesforceId    String?   @unique
  companyName     String
  email           String    @unique
  passwordHash    String
  address         String?
  phone           String?
  onboardingStage String    @default("new")
  installationDate DateTime?
  trainingDate    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model LarkAuthToken {
  id           String   @id @default(cuid())
  userEmail    String   @unique
  userName     String?
  larkUserId   String?
  userType     String?  // 'trainer', 'installer', or 'manager'
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime
  calendarId   String?
  scopes       String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userEmail])
  @@index([expiresAt])
  @@index([userType])
}

model PageView {
  id            String   @id @default(cuid())
  merchantId    String?  // Salesforce ID (nullable for login page visits)
  merchantName  String?  // Cached for easier querying
  page          String   // 'progress', 'details', 'login', 'admin', etc.
  action        String?  // 'view', 'login_success', 'login_failed', 'booking', 'upload'
  userAgent     String?  @db.Text
  deviceType    String?  // 'mobile', 'tablet', 'desktop'
  ipAddress     String?  // Hashed IP for privacy
  sessionId     String   // To track unique sessions
  isInternalUser Boolean @default(false) // Flag for internal team access
  userType      String?  // 'merchant', 'internal_team', 'admin'
  metadata      Json?    // Additional context (e.g., booking details, error messages)
  timestamp     DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([merchantId])
  @@index([page])
  @@index([timestamp])
  @@index([sessionId])
  @@index([isInternalUser])
  @@index([userType])
  @@index([deviceType])
}

model MenuSubmissionNotification {
  id              String   @id @default(cuid())
  trainerId       String   // Onboarding_Trainer__c ID
  submissionLink  String   @db.Text // Menu_Collection_Submission_Link__c value
  merchantName    String?  // For reference
  msmEmail        String?  // Manager who was notified
  notifiedAt      DateTime @default(now())
  createdAt       DateTime @default(now())

  @@unique([trainerId, submissionLink])
  @@index([trainerId])
  @@index([notifiedAt])
  @@map("menu_submission_notifications")
}

model SalesforceTaskTracking {
  id              String   @id @default(cuid())
  taskId          String   @unique // Salesforce Task.Id (18-char ID)
  trainerId       String   // Onboarding_Trainer__c ID
  taskType        TaskType
  merchantName    String?  // For reference
  msmEmail        String?  // Manager who was assigned the task
  createdAt       DateTime @default(now())
  completedAt     DateTime? // When the task was marked complete (for future automation)

  // Note: No unique constraint on trainerId+taskType to allow multiple tasks per merchant
  // (e.g., multiple VIDEO_UPLOAD tasks when merchant re-uploads)
  @@index([trainerId])
  @@index([taskType])
  @@index([createdAt])
  @@index([completedAt])
  @@index([trainerId, taskType])
  @@map("salesforce_task_tracking")
}

enum TaskType {
  MENU_SUBMISSION
  VIDEO_UPLOAD
  EXTERNAL_VENDOR_BOOKING
  TRAINING_BOOKING
  TRAINING_RESCHEDULING
  TRAINING_CANCELLATION
  INTERNAL_INSTALLATION_BOOKING
  INTERNAL_INSTALLATION_RESCHEDULING
  INTERNAL_INSTALLATION_CANCELLATION
}

model MerchantRemark {
  id          String   @id @default(cuid())
  merchantId  String   @unique // Salesforce Onboarding_Trainer__c ID
  remark      String   @db.Text
  updatedBy   String?  // Admin email who last updated
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([merchantId])
  @@map("merchant_remarks")
}

model NotificationAdmin {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String
  larkUserId String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([isActive])
  @@map("notification_admins")
}